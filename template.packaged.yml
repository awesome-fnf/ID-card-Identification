ROSTemplateFormatVersion: '2015-09-01'
Transform: 'Aliyun::Serverless-2018-04-03'
Resources:
  RAMRole:
    Type: 'ALIYUN::RAM::Role'
    Properties:
      RoleName:
        'Fn::Replace':
          - <random-suffix>:
              Ref: 'ALIYUN::StackName'
          - IDCardRole-<random-suffix>
      Description: RAM role for etl demo
      AssumeRolePolicyDocument:
        Version: 1
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service:
                - fnf.aliyuncs.com
      Policies:
        - PolicyName:
            'Fn::Replace':
              - <random-suffix>:
                  Ref: 'ALIYUN::StackName'
              - IDCardRolePolicy-<random-suffix>
          PolicyDocument:
            Version: 1
            Statement:
              - Effect: Allow
                Action:
                  - 'viapi-ocr:*'
                Resource:
                  - '*'
  id_card_recognize:
    Type: 'Aliyun::Serverless::Flow'
    Properties:
      Description: id card recognize demo
      Role:
        'Fn::GetAtt':
          - RAMRole
          - Arn
      Definition:
        'Fn::Sub': |
          version: v1beta1
          type: flow
          steps:
            - type: task
              name: APIRecognizeIdentityCard
              action: 'ocr:RecognizeIdentityCard'
              inputMappings:
                - target: image
                  source: $input.imageUrl
                - target: cardSide
                  source: face
              outputMappings:
                - target: name
                  source: $local.Data.FrontResult.Name
                - target: gender
                  source: $local.Data.FrontResult.Gender
                - target: idNumber
                  source: $local.Data.FrontResult.IDNumber
              serviceParams:
                ImageURL: $.image
                Side: $.cardSide
              retry:
                - errors:
                    - ocr.ServiceUnavailable
                    - ocr.InternalError
                    - ocr.Timeout
                    - ocr.InvalidResult
                    - ocr.InvalidImage.Download
                  intervalSeconds: 10
                  maxAttempts: 2
                  multiplier: 2
    DependsOn: []
